# Do not edit this file! It has been generated by .github/gen-workflow-ci.py

name: CI
on:
  schedule:
    - cron: "0 12 * * *"
  push:
    branches:
      - master
    tags:
      - '*'
  pull_request:

jobs:
  validate-workflow:
    name: "Verify GitHub Workflow"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Check ci.yaml is up-to-date
        run: |
          echo "::group::pip install -r .github/requirements.txt"
          pip install -r .github/requirements.txt
          echo "::endgroup::"
          python .github/gen-workflow-ci.py
          if [[ $(git diff .github/workflows/ci.yaml | wc -l) -gt 0 ]]
          then
            echo "::error::Workflow file .github/workflows/ci.yaml is out-dated, please run .github/gen-workflow-ci.py and commit changes"
            exit 1
          fi
        shell: bash

  build-and-test:
    name: "Build and Test (${{ matrix.image }})"
    needs: [validate-workflow]
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 17
      fail-fast: false
      matrix:
        include:
          - image: test-cpu-gloo-py3_6-tf2_4_1-keras2_4_3-torch1_8_1-mxnet1_8_0_p0-pyspark_2_3_4
            Elastic_Spark_TensorFlow_Tests_1: true
            Elastic_Spark_Torch_Tests: true
            Elastic_Tests_1: true
            Gloo_Cluster_PyTests: true
            Gloo_MXNet_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_2_0_Keras_MNIST: true
            Gloo_TensorFlow_2_0_MNIST: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-cpu-gloo-py3_7-tf1_15_5-keras2_2_4-torch1_3_1-mxnet1_5_1_p0-pyspark_3_1_1
            Elastic_Spark_TensorFlow_Tests_2: true
            Elastic_Tests_2: true
            Gloo_Cluster_PyTests: true
            Gloo_Keras_MNIST: true
            Gloo_MXNet_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_MNIST: true
            Single_Keras_MNIST: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Keras_MNIST: true
            Spark_Keras_Rossmann_Estimator: true
            Spark_Keras_Rossmann_Run: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-cpu-gloo-py3_7-tf2_0_4-keras2_3_1-torch1_4_0-mxnet1_5_1_p0-pyspark_3_1_1
            Elastic_Tests_1: true
            Gloo_Cluster_PyTests: true
            Gloo_MXNet_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_2_0_Keras_MNIST: true
            Gloo_TensorFlow_2_0_MNIST: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-cpu-gloo-py3_7-tf2_1_3-keras2_3_1-torch1_5_1-mxnet1_5_1_p0-pyspark_3_1_1
            Elastic_Tests_1: true
            Gloo_Cluster_PyTests: true
            Gloo_MXNet_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_2_0_Keras_MNIST: true
            Gloo_TensorFlow_2_0_MNIST: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-cpu-gloo-py3_7-tf2_4_1-keras2_4_3-torch1_8_1-mxnet1_8_0_p0-pyspark_2_4_7
            Elastic_Spark_TensorFlow_Tests_1: true
            Elastic_Spark_Torch_Tests: true
            Elastic_Tests_1: true
            Gloo_Cluster_PyTests: true
            Gloo_MXNet_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_2_0_Keras_MNIST: true
            Gloo_TensorFlow_2_0_MNIST: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-cpu-gloo-py3_8-tf2_3_2-keras2_3_1-torch1_7_1-mxnet1_7_0_p2-pyspark_3_1_1
            Elastic_Tests_1: true
            Gloo_Cluster_PyTests: true
            Gloo_MXNet_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_2_0_Keras_MNIST: true
            Gloo_TensorFlow_2_0_MNIST: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-cpu-gloo-py3_8-tf2_4_1-keras2_4_3-torch1_8_1-mxnet1_8_0_p0-pyspark_3_0_2
            Elastic_Spark_TensorFlow_Tests_1: true
            Elastic_Spark_Torch_Tests: true
            Elastic_Tests_1: true
            Gloo_Cluster_PyTests: true
            Gloo_MXNet_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_2_0_Keras_MNIST: true
            Gloo_TensorFlow_2_0_MNIST: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-cpu-gloo-py3_8-tf2_4_1-keras2_4_3-torch1_8_1-mxnet1_8_0_p0-pyspark_3_1_1
            Elastic_Spark_TensorFlow_Tests_1: true
            Elastic_Spark_Torch_Tests: true
            Elastic_Tests_1: true
            Gloo_Cluster_PyTests: true
            Gloo_MXNet_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_2_0_Keras_MNIST: true
            Gloo_TensorFlow_2_0_MNIST: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-cpu-mpich-py3_8-tf2_4_1-keras2_4_3-torch1_8_1-mxnet1_8_0_p0-pyspark_3_1_1
            MPI_Cluster_PyTests: true
            MPI_MXNet_MNIST: true
            MPI_Parallel_PyTests: true
            MPI_PyTorch_MNIST: true
            MPI_Single_PyTests: true
            MPI_TensorFlow_2_0_Keras_MNIST: true
            MPI_TensorFlow_2_0_MNIST: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            build_timeout: 30

          - image: test-cpu-openmpi-gloo-py3_8-tf2_4_1-keras2_4_3-torch1_8_1-mxnet1_8_0_p0-pyspark_3_1_1
            Elastic_Tests_1: true
            Gloo_Cluster_PyTests: true
            Gloo_MXNet_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_2_0_Keras_MNIST: true
            Gloo_TensorFlow_2_0_MNIST: true
            MPI_Cluster_PyTests: true
            MPI_MXNet_MNIST: true
            MPI_Parallel_PyTests: true
            MPI_PyTorch_MNIST: true
            MPI_Single_PyTests: true
            MPI_TensorFlow_2_0_Keras_MNIST: true
            MPI_TensorFlow_2_0_MNIST: true
            Run_PyTests_test_interactiverun: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-cpu-openmpi-py3_8-tf2_4_1-keras2_4_3-torch1_8_1-mxnet1_8_0_p0-pyspark_3_1_1
            MPI_Cluster_PyTests: true
            MPI_MXNet_MNIST: true
            MPI_Parallel_PyTests: true
            MPI_PyTorch_MNIST: true
            MPI_Single_PyTests: true
            MPI_TensorFlow_2_0_Keras_MNIST: true
            MPI_TensorFlow_2_0_MNIST: true
            Run_PyTests_test_interactiverun: true
            Single_MXNet_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-gpu-gloo-py3_7-tf1_15_5-keras2_2_4-torch1_3_1-mxnet1_5_1_p0-pyspark_3_1_1
            build_timeout: 40

          - image: test-gpu-gloo-py3_8-tf2_2_2-keras2_3_1-torch1_6_0-mxnet1_6_0_p0-pyspark_3_1_1
            build_timeout: 40

          - image: test-gpu-gloo-py3_8-tf2_3_2-keras2_3_1-torch1_7_1-mxnet1_7_0_p1-pyspark_3_1_1
            build_timeout: 40

          - image: test-gpu-openmpi-gloo-py3_8-tf2_4_1-keras2_4_3-torch1_8_1-mxnet1_8_0_p0-pyspark_3_1_1
            build_timeout: 40

          - image: test-mixed-openmpi-gloo-py3_8-tf2_4_1-keras2_4_3-torch1_8_1-mxnet1_8_0_p0-pyspark_3_1_1
            build_timeout: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Setup docker-compose
        run: pip install docker-compose

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        continue-on-error: true
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: ecr
        continue-on-error: true
        uses: aws-actions/amazon-ecr-login@v1

      - name: Add cache_from to docker-compose YAML
        # disabled as 1) the cache image is not been picked up and 2) image is too large for github workers
        if: false
        run: |
          mv docker-compose.test.yml docker-compose.test.yml.bak
          .github/add-cache-to-docker-compose.sh "${{ steps.ecr.outputs.registry }}" < docker-compose.test.yml.bak > docker-compose.test.yml
          git diff
        shell: bash

      - name: Pull latest image
        if: false
        continue-on-error: true
        run: |
          docker pull ${{ steps.ecr.outputs.registry }}/buildkite:horovod-${{ matrix.image }}-latest

      - name: Build
        id: build
        run: |
          .github/timeout-and-retry.sh ${{ matrix.build_timeout }}m 3 10 docker-compose -f docker-compose.test.yml build ${{ matrix.image }}

      - name: "Elastic Spark TensorFlow Tests 1"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Spark_TensorFlow_Tests_1
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Spark_TensorFlow_Tests_1
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Spark_TensorFlow_Tests_1:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 20m 3 10 bash -c "cd /horovod/test/integration && /spark_env.sh HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.spark.tf.xml test_elastic_spark_tensorflow2.py"
        shell: bash

      - name: "Elastic Spark TensorFlow Tests 2"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Spark_TensorFlow_Tests_2
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Spark_TensorFlow_Tests_2
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Spark_TensorFlow_Tests_2:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 20m 3 10 bash -c "cd /horovod/test/integration && /spark_env.sh HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.spark.tf.xml test_elastic_spark_tensorflow.py"
        shell: bash

      - name: "Elastic Spark Torch Tests"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Spark_Torch_Tests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Spark_Torch_Tests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Spark_Torch_Tests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 20m 3 10 bash -c "cd /horovod/test/integration && /spark_env.sh HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.spark.torch.xml test_elastic_spark_torch.py"
        shell: bash

      - name: "Elastic Tests 1"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Tests_1
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Tests_1
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Tests_1:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "cd /horovod/test/integration && HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.xml test_elastic_torch.py test_elastic_tensorflow2.py"
        shell: bash

      - name: "Elastic Tests 2"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Tests_2
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Tests_2
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Tests_2:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "cd /horovod/test/integration && HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.xml test_elastic_torch.py test_elastic_tensorflow.py test_elastic_tensorflow_keras.py"
        shell: bash

      - name: "Gloo Cluster PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_Cluster_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_Cluster_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_Cluster_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.static.xml test_static_run.py"
        shell: bash

      - name: "Gloo Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/keras/keras_mnist_advanced.py
        shell: bash

      - name: "Gloo MXNet2 MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_MXNet2_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_MXNet2_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_MXNet2_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/mxnet/mxnet2_mnist.py
        shell: bash

      - name: "Gloo MXNet MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_MXNet_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_MXNet_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_MXNet_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/mxnet/mxnet_mnist.py
        shell: bash

      - name: "Gloo Parallel PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_Parallel_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_Parallel_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_Parallel_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 5m 3 10 bash -c " cd /horovod/test/parallel && (ls -1 test_*.py | xargs -n 1 horovodrun -np 2 -H localhost:2 --gloo /bin/bash /pytest.sh gloo)"
        shell: bash

      - name: "Gloo PyTorch MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_PyTorch_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_PyTorch_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_PyTorch_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/pytorch/pytorch_mnist.py --data-dir /data/pytorch_datasets
        shell: bash

      - name: "Gloo Single PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_Single_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_Single_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_Single_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 15m 3 10 bash -c " cd /horovod/test/single && (ls -1 test_*.py | xargs -n 1 /bin/bash /pytest_standalone.sh gloo)"
        shell: bash

      - name: "Gloo TensorFlow 2.0 Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_TensorFlow_2_0_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_TensorFlow_2_0_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_TensorFlow_2_0_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/tensorflow2/tensorflow2_keras_mnist.py
        shell: bash

      - name: "Gloo TensorFlow 2.0 MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_TensorFlow_2_0_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_TensorFlow_2_0_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_TensorFlow_2_0_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/tensorflow2/tensorflow2_mnist.py
        shell: bash

      - name: "Gloo TensorFlow MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_TensorFlow_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_TensorFlow_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_TensorFlow_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/tensorflow/tensorflow_mnist.py
        shell: bash

      - name: "MPI Cluster PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Cluster_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Cluster_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Cluster_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "  /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.static.xml test_static_run.py"
        shell: bash

      - name: "MPI Cluster PyTests [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Cluster_PyTests_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Cluster_PyTests_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Cluster_PyTests_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command &&  /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.static.xml test_static_run.py"
        shell: bash

      - name: "MPI Cluster PyTests [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Cluster_PyTests_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Cluster_PyTests_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Cluster_PyTests_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command &&  /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.static.xml test_static_run.py"
        shell: bash

      - name: "MPI MXNet MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_MXNet_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_MXNet_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_MXNet_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " OMP_NUM_THREADS=1 \$(cat /mpirun_command) python /horovod/examples/mxnet/mxnet_mnist.py"
        shell: bash

      - name: "MPI MXNet MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_MXNet_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_MXNet_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_MXNet_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && OMP_NUM_THREADS=1 \$(cat /mpirun_command) python /horovod/examples/mxnet/mxnet_mnist.py"
        shell: bash

      - name: "MPI MXNet MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_MXNet_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_MXNet_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_MXNet_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && OMP_NUM_THREADS=1 \$(cat /mpirun_command) python /horovod/examples/mxnet/mxnet_mnist.py"
        shell: bash

      - name: "MPI Parallel PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Parallel_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Parallel_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Parallel_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 5m 3 10 bash -c "  cd /horovod/test/parallel && (ls -1 test_*.py | xargs -n 1 \$(cat /mpirun_command) /bin/bash /pytest.sh mpi)"
        shell: bash

      - name: "MPI Parallel PyTests [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Parallel_PyTests_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Parallel_PyTests_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Parallel_PyTests_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 5m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command &&  cd /horovod/test/parallel && (ls -1 test_*.py | xargs -n 1 \$(cat /mpirun_command) /bin/bash /pytest.sh mpi)"
        shell: bash

      - name: "MPI Parallel PyTests [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Parallel_PyTests_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Parallel_PyTests_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Parallel_PyTests_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 5m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command &&  cd /horovod/test/parallel && (ls -1 test_*.py | xargs -n 1 \$(cat /mpirun_command) /bin/bash /pytest.sh mpi)"
        shell: bash

      - name: "MPI PyTorch MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_PyTorch_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " \$(cat /mpirun_command) python /horovod/examples/pytorch/pytorch_mnist.py --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "MPI PyTorch MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_PyTorch_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/pytorch/pytorch_mnist.py --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "MPI PyTorch MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_PyTorch_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/pytorch/pytorch_mnist.py --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "MPI Single PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Single_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Single_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Single_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "  cd /horovod/test/single && (ls -1 test_*.py | xargs -n 1 /bin/bash /pytest_standalone.sh mpi)"
        shell: bash

      - name: "MPI Single PyTests [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Single_PyTests_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Single_PyTests_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Single_PyTests_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command &&  cd /horovod/test/single && (ls -1 test_*.py | xargs -n 1 /bin/bash /pytest_standalone.sh mpi)"
        shell: bash

      - name: "MPI Single PyTests [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Single_PyTests_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Single_PyTests_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Single_PyTests_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command &&  cd /horovod/test/single && (ls -1 test_*.py | xargs -n 1 /bin/bash /pytest_standalone.sh mpi)"
        shell: bash

      - name: "MPI TensorFlow 2.0 Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_keras_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 Keras MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_keras_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 Keras MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_keras_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_mnist.py"
        shell: bash

      - name: "Run PyTests test_interactiverun"
        if: always() && steps.build.outcome == 'success' && matrix.Run_PyTests_test_interactiverun
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Run_PyTests_test_interactiverun
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Run_PyTests_test_interactiverun:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "cd /horovod/test && pytest -v --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.integration.xml integration/test_interactiverun.py"
        shell: bash

      - name: "Single Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Single_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " python /horovod/examples/keras/keras_mnist_advanced.py --epochs 3 --batch-size 64"
        shell: bash

      - name: "Single MXNet2 MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Single_MXNet2_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_MXNet2_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_MXNet2_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " python /horovod/examples/mxnet/mxnet2_mnist.py --epochs 3"
        shell: bash

      - name: "Single MXNet MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Single_MXNet_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_MXNet_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_MXNet_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " python /horovod/examples/mxnet/mxnet_mnist.py --epochs 3"
        shell: bash

      - name: "Single MXNet MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.Single_MXNet_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_MXNet_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_MXNet_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && python /horovod/examples/mxnet/mxnet_mnist.py --epochs 3"
        shell: bash

      - name: "Single MXNet MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.Single_MXNet_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_MXNet_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_MXNet_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && python /horovod/examples/mxnet/mxnet_mnist.py --epochs 3"
        shell: bash

      - name: "Single PyTorch MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Single_PyTorch_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_PyTorch_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_PyTorch_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " python /horovod/examples/pytorch/pytorch_mnist.py --epochs 3 --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "Single PyTorch MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.Single_PyTorch_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_PyTorch_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_PyTorch_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && python /horovod/examples/pytorch/pytorch_mnist.py --epochs 3 --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "Single PyTorch MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.Single_PyTorch_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_PyTorch_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_PyTorch_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && python /horovod/examples/pytorch/pytorch_mnist.py --epochs 3 --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "Spark Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/keras/keras_spark_mnist.py --num-proc 2 --work-dir /work --data-dir /data --epochs 3"
        shell: bash

      - name: "Spark Keras Rossmann Estimator"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Keras_Rossmann_Estimator
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Keras_Rossmann_Estimator
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Keras_Rossmann_Estimator:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/keras/keras_spark_rossmann_estimator.py --num-proc 2 --work-dir /work --data-dir file:///data --epochs 3 --sample-rate 0.01"
        shell: bash

      - name: "Spark Keras Rossmann Run"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Keras_Rossmann_Run
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Keras_Rossmann_Run
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Keras_Rossmann_Run:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/keras/keras_spark_rossmann_run.py --num-proc 2 --data-dir file:///data --epochs 3 --sample-rate 0.01"
        shell: bash

      - name: "Spark Lightning MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Lightning_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Lightning_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Lightning_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/pytorch/pytorch_lightning_spark_mnist.py --num-proc 2 --work-dir /work --data-dir /data --epochs 3"
        shell: bash

      - name: "Spark PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "cd /horovod/test/integration && (ls -1 test_spark*.py | xargs -n 1 /bin/bash /pytest_standalone.sh spark)"
        shell: bash

      - name: "Spark Torch MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Torch_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Torch_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Torch_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/pytorch/pytorch_spark_mnist.py --num-proc 2 --work-dir /work --data-dir /data --epochs 3"
        shell: bash

      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always() && contains(matrix.image, '-cpu-')
        with:
          name: Unit Test Results - ${{ matrix.image }}
          path: artifacts/${{ matrix.image }}/**/*.xml

  build-and-test-heads:
    name: "Build and Test (${{ matrix.image }})"
    needs: [build-and-test]
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        include:
          - image: test-cpu-gloo-py3_8-tfhead-keras_none-torchhead-mxnethead-pyspark_3_1_1
            Elastic_Tests_1: true
            Gloo_Cluster_PyTests: true
            Gloo_MXNet2_MNIST: true
            Gloo_Parallel_PyTests: true
            Gloo_PyTorch_MNIST: true
            Gloo_Single_PyTests: true
            Gloo_TensorFlow_2_0_Keras_MNIST: true
            Gloo_TensorFlow_2_0_MNIST: true
            Single_MXNet2_MNIST: true
            Single_PyTorch_MNIST: true
            Spark_Lightning_MNIST: true
            Spark_PyTests: true
            Spark_Torch_MNIST: true
            build_timeout: 30

          - image: test-gpu-gloo-py3_8-tfhead-keras_none-torchhead-mxnethead-pyspark_3_1_1
            build_timeout: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Setup docker-compose
        run: pip install docker-compose

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        continue-on-error: true
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: ecr
        continue-on-error: true
        uses: aws-actions/amazon-ecr-login@v1

      - name: Add cache_from to docker-compose YAML
        # disabled as 1) the cache image is not been picked up and 2) image is too large for github workers
        if: false
        run: |
          mv docker-compose.test.yml docker-compose.test.yml.bak
          .github/add-cache-to-docker-compose.sh "${{ steps.ecr.outputs.registry }}" < docker-compose.test.yml.bak > docker-compose.test.yml
          git diff
        shell: bash

      - name: Pull latest image
        if: false
        continue-on-error: true
        run: |
          docker pull ${{ steps.ecr.outputs.registry }}/buildkite:horovod-${{ matrix.image }}-latest

      - name: Build
        id: build
        run: |
          .github/timeout-and-retry.sh ${{ matrix.build_timeout }}m 3 10 docker-compose -f docker-compose.test.yml build ${{ matrix.image }}

      - name: "Elastic Spark TensorFlow Tests 1"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Spark_TensorFlow_Tests_1
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Spark_TensorFlow_Tests_1
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Spark_TensorFlow_Tests_1:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 20m 3 10 bash -c "cd /horovod/test/integration && /spark_env.sh HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.spark.tf.xml test_elastic_spark_tensorflow2.py"
        shell: bash

      - name: "Elastic Spark TensorFlow Tests 2"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Spark_TensorFlow_Tests_2
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Spark_TensorFlow_Tests_2
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Spark_TensorFlow_Tests_2:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 20m 3 10 bash -c "cd /horovod/test/integration && /spark_env.sh HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.spark.tf.xml test_elastic_spark_tensorflow.py"
        shell: bash

      - name: "Elastic Spark Torch Tests"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Spark_Torch_Tests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Spark_Torch_Tests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Spark_Torch_Tests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 20m 3 10 bash -c "cd /horovod/test/integration && /spark_env.sh HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.spark.torch.xml test_elastic_spark_torch.py"
        shell: bash

      - name: "Elastic Tests 1"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Tests_1
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Tests_1
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Tests_1:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "cd /horovod/test/integration && HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.xml test_elastic_torch.py test_elastic_tensorflow2.py"
        shell: bash

      - name: "Elastic Tests 2"
        if: always() && steps.build.outcome == 'success' && matrix.Elastic_Tests_2
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Elastic_Tests_2
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Elastic_Tests_2:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "cd /horovod/test/integration && HOROVOD_LOG_LEVEL=DEBUG pytest --forked -v --log-cli-level 10 --log-cli-format '[%(asctime)-15s %(levelname)s %(filename)s:%(lineno)d %(funcName)s()] %(message)s' --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.elastic.xml test_elastic_torch.py test_elastic_tensorflow.py test_elastic_tensorflow_keras.py"
        shell: bash

      - name: "Gloo Cluster PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_Cluster_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_Cluster_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_Cluster_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.static.xml test_static_run.py"
        shell: bash

      - name: "Gloo Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/keras/keras_mnist_advanced.py
        shell: bash

      - name: "Gloo MXNet2 MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_MXNet2_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_MXNet2_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_MXNet2_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/mxnet/mxnet2_mnist.py
        shell: bash

      - name: "Gloo MXNet MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_MXNet_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_MXNet_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_MXNet_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/mxnet/mxnet_mnist.py
        shell: bash

      - name: "Gloo Parallel PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_Parallel_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_Parallel_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_Parallel_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 5m 3 10 bash -c " cd /horovod/test/parallel && (ls -1 test_*.py | xargs -n 1 horovodrun -np 2 -H localhost:2 --gloo /bin/bash /pytest.sh gloo)"
        shell: bash

      - name: "Gloo PyTorch MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_PyTorch_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_PyTorch_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_PyTorch_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/pytorch/pytorch_mnist.py --data-dir /data/pytorch_datasets
        shell: bash

      - name: "Gloo Single PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_Single_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_Single_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_Single_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 15m 3 10 bash -c " cd /horovod/test/single && (ls -1 test_*.py | xargs -n 1 /bin/bash /pytest_standalone.sh gloo)"
        shell: bash

      - name: "Gloo TensorFlow 2.0 Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_TensorFlow_2_0_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_TensorFlow_2_0_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_TensorFlow_2_0_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/tensorflow2/tensorflow2_keras_mnist.py
        shell: bash

      - name: "Gloo TensorFlow 2.0 MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_TensorFlow_2_0_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_TensorFlow_2_0_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_TensorFlow_2_0_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/tensorflow2/tensorflow2_mnist.py
        shell: bash

      - name: "Gloo TensorFlow MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Gloo_TensorFlow_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Gloo_TensorFlow_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Gloo_TensorFlow_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 horovodrun -np 2 -H localhost:2 --gloo python /horovod/examples/tensorflow/tensorflow_mnist.py
        shell: bash

      - name: "MPI Cluster PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Cluster_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Cluster_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Cluster_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "  /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.static.xml test_static_run.py"
        shell: bash

      - name: "MPI Cluster PyTests [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Cluster_PyTests_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Cluster_PyTests_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Cluster_PyTests_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command &&  /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.static.xml test_static_run.py"
        shell: bash

      - name: "MPI Cluster PyTests [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Cluster_PyTests_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Cluster_PyTests_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Cluster_PyTests_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command &&  /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.static.xml test_static_run.py"
        shell: bash

      - name: "MPI MXNet MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_MXNet_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_MXNet_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_MXNet_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " OMP_NUM_THREADS=1 \$(cat /mpirun_command) python /horovod/examples/mxnet/mxnet_mnist.py"
        shell: bash

      - name: "MPI MXNet MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_MXNet_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_MXNet_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_MXNet_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && OMP_NUM_THREADS=1 \$(cat /mpirun_command) python /horovod/examples/mxnet/mxnet_mnist.py"
        shell: bash

      - name: "MPI MXNet MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_MXNet_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_MXNet_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_MXNet_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && OMP_NUM_THREADS=1 \$(cat /mpirun_command) python /horovod/examples/mxnet/mxnet_mnist.py"
        shell: bash

      - name: "MPI Parallel PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Parallel_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Parallel_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Parallel_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 5m 3 10 bash -c "  cd /horovod/test/parallel && (ls -1 test_*.py | xargs -n 1 \$(cat /mpirun_command) /bin/bash /pytest.sh mpi)"
        shell: bash

      - name: "MPI Parallel PyTests [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Parallel_PyTests_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Parallel_PyTests_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Parallel_PyTests_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 5m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command &&  cd /horovod/test/parallel && (ls -1 test_*.py | xargs -n 1 \$(cat /mpirun_command) /bin/bash /pytest.sh mpi)"
        shell: bash

      - name: "MPI Parallel PyTests [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Parallel_PyTests_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Parallel_PyTests_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Parallel_PyTests_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 5m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command &&  cd /horovod/test/parallel && (ls -1 test_*.py | xargs -n 1 \$(cat /mpirun_command) /bin/bash /pytest.sh mpi)"
        shell: bash

      - name: "MPI PyTorch MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_PyTorch_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " \$(cat /mpirun_command) python /horovod/examples/pytorch/pytorch_mnist.py --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "MPI PyTorch MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_PyTorch_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/pytorch/pytorch_mnist.py --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "MPI PyTorch MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_PyTorch_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_PyTorch_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/pytorch/pytorch_mnist.py --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "MPI Single PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Single_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Single_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Single_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "  cd /horovod/test/single && (ls -1 test_*.py | xargs -n 1 /bin/bash /pytest_standalone.sh mpi)"
        shell: bash

      - name: "MPI Single PyTests [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Single_PyTests_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Single_PyTests_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Single_PyTests_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command &&  cd /horovod/test/single && (ls -1 test_*.py | xargs -n 1 /bin/bash /pytest_standalone.sh mpi)"
        shell: bash

      - name: "MPI Single PyTests [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_Single_PyTests_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_Single_PyTests_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_Single_PyTests_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command &&  cd /horovod/test/single && (ls -1 test_*.py | xargs -n 1 /bin/bash /pytest_standalone.sh mpi)"
        shell: bash

      - name: "MPI TensorFlow 2.0 Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_keras_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 Keras MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_keras_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 Keras MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_Keras_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_keras_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_mnist.py"
        shell: bash

      - name: "MPI TensorFlow 2.0 MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.MPI_TensorFlow_2_0_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/MPI_TensorFlow_2_0_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && \$(cat /mpirun_command) python /horovod/examples/tensorflow2/tensorflow2_mnist.py"
        shell: bash

      - name: "Run PyTests test_interactiverun"
        if: always() && steps.build.outcome == 'success' && matrix.Run_PyTests_test_interactiverun
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Run_PyTests_test_interactiverun
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Run_PyTests_test_interactiverun:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "cd /horovod/test && pytest -v --capture=no --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.integration.xml integration/test_interactiverun.py"
        shell: bash

      - name: "Single Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Single_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " python /horovod/examples/keras/keras_mnist_advanced.py --epochs 3 --batch-size 64"
        shell: bash

      - name: "Single MXNet2 MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Single_MXNet2_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_MXNet2_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_MXNet2_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " python /horovod/examples/mxnet/mxnet2_mnist.py --epochs 3"
        shell: bash

      - name: "Single MXNet MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Single_MXNet_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_MXNet_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_MXNet_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " python /horovod/examples/mxnet/mxnet_mnist.py --epochs 3"
        shell: bash

      - name: "Single MXNet MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.Single_MXNet_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_MXNet_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_MXNet_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && python /horovod/examples/mxnet/mxnet_mnist.py --epochs 3"
        shell: bash

      - name: "Single MXNet MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.Single_MXNet_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_MXNet_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_MXNet_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && python /horovod/examples/mxnet/mxnet_mnist.py --epochs 3"
        shell: bash

      - name: "Single PyTorch MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Single_PyTorch_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_PyTorch_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_PyTorch_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c " python /horovod/examples/pytorch/pytorch_mnist.py --epochs 3 --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "Single PyTorch MNIST [ONECCL MPI]"
        if: always() && steps.build.outcome == 'success' && matrix.Single_PyTorch_MNIST_ONECCL_MPI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_PyTorch_MNIST_ONECCL_MPI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_PyTorch_MNIST_ONECCL_MPI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_mpi' > /mpirun_command && python /horovod/examples/pytorch/pytorch_mnist.py --epochs 3 --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "Single PyTorch MNIST [ONECCL OFI]"
        if: always() && steps.build.outcome == 'success' && matrix.Single_PyTorch_MNIST_ONECCL_OFI
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Single_PyTorch_MNIST_ONECCL_OFI
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Single_PyTorch_MNIST_ONECCL_OFI:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "\$(cat /oneccl_env) && echo '/mpirun_command_ofi' > /mpirun_command && python /horovod/examples/pytorch/pytorch_mnist.py --epochs 3 --data-dir /data/pytorch_datasets"
        shell: bash

      - name: "Spark Keras MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Keras_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Keras_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Keras_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/keras/keras_spark_mnist.py --num-proc 2 --work-dir /work --data-dir /data --epochs 3"
        shell: bash

      - name: "Spark Keras Rossmann Estimator"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Keras_Rossmann_Estimator
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Keras_Rossmann_Estimator
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Keras_Rossmann_Estimator:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/keras/keras_spark_rossmann_estimator.py --num-proc 2 --work-dir /work --data-dir file:///data --epochs 3 --sample-rate 0.01"
        shell: bash

      - name: "Spark Keras Rossmann Run"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Keras_Rossmann_Run
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Keras_Rossmann_Run
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Keras_Rossmann_Run:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/keras/keras_spark_rossmann_run.py --num-proc 2 --data-dir file:///data --epochs 3 --sample-rate 0.01"
        shell: bash

      - name: "Spark Lightning MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Lightning_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Lightning_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Lightning_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/pytorch/pytorch_lightning_spark_mnist.py --num-proc 2 --work-dir /work --data-dir /data --epochs 3"
        shell: bash

      - name: "Spark PyTests"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_PyTests
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_PyTests
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_PyTests:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "cd /horovod/test/integration && (ls -1 test_spark*.py | xargs -n 1 /bin/bash /pytest_standalone.sh spark)"
        shell: bash

      - name: "Spark Torch MNIST"
        if: always() && steps.build.outcome == 'success' && matrix.Spark_Torch_MNIST
        run: |
          mkdir -p artifacts/${{ matrix.image }}/Spark_Torch_MNIST
          docker-compose -f docker-compose.test.yml run -e GITHUB_ACTIONS --rm --volume "$(pwd)/artifacts/${{ matrix.image }}/Spark_Torch_MNIST:/artifacts" ${{ matrix.image }} /bin/bash /horovod/.github/timeout-and-retry.sh 10m 3 10 bash -c "OMP_NUM_THREADS=1 /spark_env.sh python /horovod/examples/spark/pytorch/pytorch_spark_mnist.py --num-proc 2 --work-dir /work --data-dir /data --epochs 3"
        shell: bash

      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always() && contains(matrix.image, '-cpu-')
        with:
          name: Unit Test Results - ${{ matrix.image }}
          path: artifacts/${{ matrix.image }}/**/*.xml

  build-and-test-macos:
    name: "Build and Test (${{ matrix.image }}-macos)"
    needs: [build-and-test]
    runs-on: macos-latest
    strategy:
      max-parallel: 3
      fail-fast: false
      matrix:
        include:
          - image: test-cpu-openmpi-py3_7-tf1_15_5-keras2_2_4-torch1_2_0-mxnet1_5_0
            HOROVOD_WITH_MPI: 1
            HOROVOD_WITHOUT_GLOO: 1
            TENSORFLOW: 1.15.0
            KERAS: 2.2.4
            PYTORCH: 1.2.0
            PYTORCH_LIGHTNING: 0.7.6
            TORCHVISION: 0.4.0
            MXNET: 1.5.0

          - image: test-cpu-gloo-py3_8-tf2_2_0-keras2_3_1-torch1_5_0-mxnet1_5_0
            HOROVOD_WITHOUT_MPI: 1
            HOROVOD_WITH_GLOO: 1
            TENSORFLOW: 2.2.0
            KERAS: 2.3.1
            PYTORCH: 1.5.0
            PYTORCH_LIGHTNING: 1.2.9
            TORCHVISION: 0.6.0
            MXNET: 1.5.0

          - image: test-openmpi-cpu-gloo-py3_8-tf2_3_0-keras2_3_1-torch1_6_0-mxnet1_5_0
            HOROVOD_WITH_MPI: 1
            HOROVOD_WITH_GLOO: 1
            TENSORFLOW: 2.3.0
            KERAS: 2.3.1
            PYTORCH: 1.6.0
            PYTORCH_LIGHTNING: 1.2.9
            TORCHVISION: 0.7.0
            MXNET: 1.5.0

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Build and Test
        env:
          HOROVOD_WITH_MPI: ${{ matrix.HOROVOD_WITH_MPI }}
          HOROVOD_WITHOUT_MPI: ${{ matrix.HOROVOD_WITHOUT_MPI }}
          HOROVOD_WITH_GLOO: ${{ matrix.HOROVOD_WITH_GLOO }}
          HOROVOD_WITHOUT_GLOO: ${{ matrix.HOROVOD_WITHOUT_GLOO }}
          TENSORFLOW: ${{ matrix.TENSORFLOW }}
          KERAS: ${{ matrix.KERAS }}
          PYTORCH: ${{ matrix.PYTORCH }}
          PYTORCH_LIGHTNING: ${{ matrix.PYTORCH_LIGHTNING }}
          TORCHVISION: ${{ matrix.TORCHVISION }}
          MXNET: ${{ matrix.MXNET }}

        run: |
          brew install openmpi cmake libuv pyenv
          export PATH=$(pyenv root)/shims:$PATH
          pyenv install 3.7.7
          pyenv global 3.7.7
          python --version

          python -m pip install -U pip
          pip install tensorflow==${TENSORFLOW} keras==${KERAS}
          pip install torch==${PYTORCH} pytorch_lightning==${PYTORCH_LIGHTNING} torchvision==${TORCHVISION}
          pip install mxnet==${MXNET}
          HOROVOD_WITH_TENSORFLOW=1 HOROVOD_WITH_PYTORCH=1 HOROVOD_WITH_MXNET=1 pip install --no-cache-dir .[test]
          horovodrun --check-build

          mkdir -p artifacts/${{ matrix.image }}-macos
          echo pytest -v --capture=no --continue-on-collection-errors --junit-xml=$(dirname "$0")/artifacts/${{ matrix.image }}-macos/junit.\$1.\${HOROVOD_RANK:-\${OMPI_COMM_WORLD_RANK:-\${PMI_RANK}}}.\$2.xml \${@:2} > pytest.sh
          chmod u+x pytest.sh
          cd test/parallel
          ls test_*.py | xargs -n 1 horovodrun -np 2 /bin/bash ../../pytest.sh macos
          find ../..

      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: Unit Test Results - ${{ matrix.image }}-macos
          path: artifacts/${{ matrix.image }}-macos/**/*.xml

  buildkite:
    name: "Build and Test (GPUs on Builtkite)"
    needs: [build-and-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Trigger Buildkite Pipeline
        id: build
        uses: EnricoMi/trigger-pipeline-action@master
        env:
          PIPELINE: "horovod/horovod"
          BRANCH: "${{ github.event.pull_request.head.ref }}"
          MESSAGE: "GPU Tests triggered by GitHub"
          BUILDKITE_API_ACCESS_TOKEN: ${{ secrets.BUILDKITE_TOKEN }}
          BUILD_ENV_VARS: "{\"PIPELINE_MODE\": \"GPU FULL\"}"

      - name: Download Buildkite Artifacts
        uses: docker://ghcr.io/enricomi/download-buildkite-artifact-action:v1
        with:
          github_token: ${{ github.token }}
          buildkite_token: ${{ secrets.BUILDKITE_TOKEN }}
          buildkite_build_url: ${{ steps.build.outputs.url }}
          ignore_build_states: blocked,canceled,skipped,not_run
          ignore_job_states: timed_out
          output_path: artifacts/Unit Test Results - GPUs on Buildkite

      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: Unit Test Results - GPUs on Builtkite
          path: artifacts/Unit Test Results - GPUs on Buildkite/**/*.xml

  publish-test-results:
    name: "Publish Unit Tests Results"
    needs: [build-and-test, build-and-test-heads, build-and-test-macos, buildkite]
    runs-on: ubuntu-latest
    if: >
      always() &&
      ( github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository )

    steps:
      - name: Download GitHub Artifacts
        uses: actions/download-artifact@v2
        with:
          path: artifacts

      - name: Publish Unit Test Results
        uses: docker://ghcr.io/enricomi/publish-unit-test-result-action:v1
        if: always()
        with:
          github_token: ${{ github.token }}
          files: "artifacts/Unit Test Results */**/*.xml"
